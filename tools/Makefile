CXX                 =  g++ -std=c++11

SRC_DIR             =   $(shell cat src_dir)
INC                 =   -I $(SRC_DIR)  -I . -I /usr/include/freetype2
CXXFLAGS            ?=  -DDEBUG -DUSE_SDL2 -g -Wall

MKDIR               =   mkdir -p

#Subdirectoies that store the sources of r64fx itself.
R64FX_SOURCE_DIRS   =   utf8string jit gc gui dsp json main

#Subdirectoies that may store glsl files that have to be compiled into resources.
GLSL_DIRS           =  $(SRC_DIR)/gui

PNG_RESOURCE_DIRS   =  $(SRC_DIR)/data/textures

.VPATH              =  $(GLSL_DIRS) $(PNG_RESOURCE_DIRS)

all: 
	@+make --silent autoconfig && make --silent r64fx

#resource compilers
file2str:$(SRC_DIR)/tools/file2str.cpp
	@printf "Building file2str tool...\n" && $(CXX) $^ -O2 -o file2str

file2numlist: $(SRC_DIR)/tools/file2numlist.cpp
	@printf "Building file2numlist tool...\n" && $(CXX) $^ -O2 -o file2numlist
	
png2numlist: $(SRC_DIR)/tools/png2numlist.cpp
	@printf "Building png2numlist tool...\n" && $(CXX) -I $(SRC_DIR) $^ -O2 -o png2numlist -lpng


#helper scripts
gen_build_rules.sh: src_dir
	@ln -sf $(SRC_DIR)/tools/gen_build_rules.sh

gen_resource_rules.sh: src_dir
	@ln -sf $(SRC_DIR)/tools/gen_resource_rules.sh

autoconfig: gen_build_rules.sh gen_resource_rules.sh file2str png2numlist jura_book_font.ttf.h
	@$(RM) build_rules; \
printf "Building resources..."; \
./gen_resource_rules.sh ./file2str '*.glsl' $(GLSL_DIRS) >> build_rules; \
./gen_resource_rules.sh ./file2str '*.vert' $(GLSL_DIRS) >> build_rules; \
./gen_resource_rules.sh ./file2str '*.frag' $(GLSL_DIRS) >> build_rules; \
./gen_resource_rules.sh ./png2numlist '*.png' $(PNG_RESOURCE_DIRS) >> build_rules; \
printf "\nAnalyzing sources..."; \
./gen_build_rules.sh '$(CXX) $(INC) $(CXXFLAGS)' $(R64FX_SOURCE_DIRS) >> build_rules; \
printf "\n"

#autogenerated build rules
-include build_rules

jura_book_font.ttf.h: file2numlist $(SRC_DIR)/data/fonts/Jura/Jura-Book.ttf
	@./file2numlist $(SRC_DIR)/data/fonts/Jura/Jura-Book.ttf > jura_book_font.ttf.h

r64fx: $(object_files)
	@printf "Linking r64fx..." && $(CXX) $^ -o $@ -lSDL2 -lGL -lGLU -lGLEW -lftgl -lpng -ljack -lsndfile && printf "\nOK\n"

clean:
	@$(RM) *.o r64fx *.sh build_rules *.h file2numlist file2str png2numlist